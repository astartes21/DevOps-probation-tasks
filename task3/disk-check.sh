#!/bin/bash
# ================================================================================
# Скрипт проверки состояния диска на занятый объём памяти в процентах.
#
# В скрипте задаётся пороговое значение $THRESHOLD, при превышении которого скрипт
# отправляет соответствующее предупреждение на почту администратора.
# ================================================================================

# Загрузка параметров smtp-клиента из config.env
source ./config.env

# Установка порогового значения загрузки диска в процентах
THRESHOLD=85

# Получение текущей загрузки диска в процентах
USAGE=$(df -h "$CHECK_PATH" | awk 'NR==2 {print $5}' | tr -d '%')

# Проверка на превышение порога загрузки
if [ "$USAGE" -ge "$THRESHOLD" ]; then
    echo "Загрузка диска превышает порог: $USAGE%"
    echo "Отправка уведомления на почту администратора..."

    SUBJECT="Мало памяти на диске $CHECK_PATH!: использовано $USAGE%"
    BODY="На сервере $hostname, по состоянию на $date, диск $CHECK_PATH занят на $USAGE%."

    echo -e "Subject: $SUBJECT\n\n$BODY" | msmtp "$ALERT_TO"
else
    echo "Загрузка диска в норме: $USAGE%"
fi
